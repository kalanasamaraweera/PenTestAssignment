# PenTestAssignment
SLIIT Penetration Testing Assignment 2020 (3rd Semester)

by S.A.K.G. Samaraweera  (MS19804552)


## SYNOPSIS
Following  document explains expliotation procedure of discovered vulnerabilities in Python Django framework. Django is  aPython based web application development framework, initialy released on 2005.

### Reference

Source Code: https://github.com/django/django

Documentation: https://www.djangoproject.com/

## Setup Environment

First we'll install Python 3.7 distribution on our host OS Ubuntu. In this case, I've used `Ubuntu 18.04.3 LTS` for the analysis.

1. Install Python 3.7
 
 Open terminal and execute below command to install Python.
 
 `sudo apt-get install python3`  

  (Note: By default Ubuntu has Python 2.7 distribution installed. However we use Python 3.7 for our analysis. Therefore recommend to uninstall 2.7 version)

 Assuming, Python 2.7 has uninstalled; We can set below alias to invoke Python 3. Otherwise  you can use `python3` command for rest of the tutorial.
 
 `alias python=python3`

 2. Install Python Package Manager

 Next, we can try installing Python package manager `pip3`. Therefore run below command:

 `sudo apt-get install -y python3-pip`

 Then again, we can set alias for pip3 same as above.

 `alias pip3=pip`

 3. Create Virtual Environment

We use `pip3` to download Python virtual environment package. Virtual environment isolates dependent packages from Python global environment. Therefore it avoids any potential conflicts of dependencies with global environment provided by standard Python installation. For example, we can have our vulnerable Django package installed on a pre-configured environment, while having the patched version in the global environment. This provides a primitive sand-box for our PenTest analysis and hardening to host's global environment.

Run below command to install environment package

`pip install virtualenv`

4. Create Virtual Environment

Create directory to setup our solution.

`mkdir PenTestAssignment`

Navigate inside created directory

`cd PenTestAssignment`

Now, we can create a our Python environment for the analysis. So, execute below command

`virtualenv env`

Once environment has created use below command to  access it
 
 `. env\bin\activate `

 Note our domain user prefix changes to `<USER-NAME>@<MACHINE-NAME>(env)` on console. Now we can head for installing Django and create a  sample project.


## Create Project

Use below command to install Django framework on our local environment. This will 
take a moment.

`pip install django==2.2.11`

Here, we can mention the specific version of package that we want to install. Next, we can go ahead creating our project. 

`django-admin startproject HackMeIfUCan`

Once the project has created, we need to set the `http` port where it will be accessible. Also we need to mention the  IP-Address of host's network interface, where our application getting exposed to the domain.

We can use below firewall rule to open port 8000 where Django hosts by default.

`sudo ufw allow 8000`

Then we need to mention the IP-Address, where the application can be publically accessible. Open terminal and type `ifconfig`. In my case it has `enp3s0` as the IP-Version-4 network interface. 

Copy the displayed IP-Version-4 Ip-Address; then move inside the created Django project (i.e. HackMeIfUCan). Access the sub-folder `HackMeIfUCAn`.  Open-up the `settings.py` file. You can use nano editor for this.

`nano settings.py`

Include the copied IP-Address to `ALLOWED_HOSTS=[]` array. Now we are ready to startup our project. In Django, enrty point for project startup is `manage.py`, located inside root folder of Django project.

    --HackMeIfUCan 
        --HackMeIfUCan
            | -- settings.py
            | -- asgi.py
            | -- wsgi.py
            | -- urls.py
            | -- __init__.py
        -- manage.py


Run below command to start hosting the application.

`python manage.py runserver <ABOVE-IP-ADDRESS>:8000`

## Configure Database
 
 Now we can configure a database for our application. First we need to stop the server.
 We can use `Ctrl + C` command to kill the execution in command line.

1. Install Database Package

 For this analysis, I use `PostgreSQL`  database server. So that, run below command to install the database server package. Make sure to run this command on our created environment.

`sudo apt install postgresql postgresql-contrib`

Note here, we install `postgresql-contrib` which includes additional functionalities for database management system.

Ref: https://packages.debian.org/jessie/postgresql-contrib-9.4

2. Create database and user 

Run below command to access database server

`sudo -u postgres psql`

This will enable console mode  access to PostgreSQL server. Now we can create our database and  a corresponding user account.

`CREATE DATABASE hackmeifucan`

`CREATE USER hackmeadmin WITH PASSWORD 'password';`

Now we can set below configuration to above user where Django requires while accessing database.

```sql
# Default Encoding UTF-8 expected by Django
ALTER ROLE hackmeadmin SET client_encoding TO 'utf8';

# Set timezone for user role
ALTER ROLE hackmeadmin SET timezone TO 'UTC';

# Grant privilleges for user
GRANT ALL PRIVILEGES ON DATABASE hackmeifucan TO hackmeadmin;
```

Use ` \q ` command to exit console.

3. Setup Django configurations

Next we can change our Django `settings.py ` to access the database. So that all Django instances will be saved to our database. As for PostgreSQL Django provides `django.db.backends.postgresql_psycopg2` backend library. For this we install `psycopg2` library. Run below command

`pip install psycopg2-binary`


Open `settings.py` file again. Default Django project is set to SQLite database configuration. So, we can replace the `DATABASE` object as follows

```python

DATABASES = {

    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': 'hackmeifucan',
        'USER': 'hackmeadmin',
        'PASSWORD': 'password',
        'HOST': 'localhost',
        'PORT': '',
    }
}
```

4. Migrate configurations

Finally, we'll transfer our project configurations into database. 

```
python manage.py makemigrations

python manage.py migrate
```

 ## Create the Sample App

1. Create new App

Next, we go ahead creating our Django app. We name it as `StudentGradesApp`
So, type below command on console.

```
python manage.py startapp StudentGradesApp
```
Then we'll mention our app in project `settings.py` file. This will import the app components to our project at runtime.  Add  `StudentGradesApp` entry to `INSTALLED_APPS` array in `settings.py`.

```python
# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'StudentGradesApp',
]
```
As next step, we'll create a view in our app and set routing.
Open  `view.py` in `StudentGradesApp` folder. Inlude below code snippet.

```python
from django.shortcuts import render
from django.http import HttpResponse

def index(request):
    return HttpResponse("Welcome to Student Grades App")
```

2. Routing to App

Then we set route for this view. For that, create `urls.py` file inside the `StudentGradesApp`. Include below snippet inside `urls.py`
```python
from django.urls import path
from . import views

urlpatterns = [

    path('', views.index, name='index'),
]
```
Now we need set the navigation to our app from our project root url. This time open `urls.py` inside the project folder `HackMeIfUCan`. Replace `django.urls` imclusion with below line.

```python
from django.urls import path, include
```
Inlcude below routing entry to naviagate our app.

```python
urlpatterns = [

    # Route to StudentGradesApp
    path('StudentGradesApp/', include('StudentGradesApp.urls')),

    path('admin/', admin.site.urls),
]

```
3. Create new Model

Now we can create the model. A model represents an entity of the application. As for our scenario we create `Student` model which has three fields; `first-name`, `last-name` and `grade`. Open `models.py` and include below models. Here I will use single model to demonstrate our penitration.

```python
from django.db import models

class Student(models.Model):
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    grade = models.CharField(max_length=100)

```

Then we need to migrate the changes to database. Simply we execute migrate command again as did in step(4).

```
(env) kalana@slave-node:~/PenTest/PenTestAssignment/HackMeIfUCan$ python manage.py makemigrations
Migrations for 'StudentGradesApp':
  StudentGradesApp/migrations/0001_initial.py
    - Create model Student
(env) kalana@slave-node:~/PenTest/PenTestAssignment/HackMeIfUCan$ python manage.py migrate
Operations to perform:
  Apply all migrations: StudentGradesApp, admin, auth, contenttypes, sessions
Running migrations:
  Applying StudentGradesApp.0001_initial... OK
```
4. Content Management System (CMS)

 Django has a built-in CMS one of coolest features it has :slightly_smiling_face: 
CMS allows admins to manage data in database stored as models.

 However models are unavailble in backend by default. So, we need to manually register them on Django administration. Therefore, include below content to your `admin.py` file
in the  `StudentGradesApp`.

```python
from django.contrib import admin
from StudentGradesApp.models import Student

admin.site.register(Student)
```

5. Create Admin account

Next, we go ahead  and create admin account for accessing backend CMS. Execute below command using `manage.py`
```
$ python manage.py createsuperuser
$ Username (leave blank to use '<YOUR-NAME>'): admin
$ Email address: <YOUR-EMAIL>
$ Password: 
$ Password (again): 
```
Once finished, startup the application and navigate below url. Use above credentials to sign in to backend.
```
http://192.168.1.5:8000/admin/
```
Once signed-in, you'll notice our model `Student` is available. If all these are working, we are good to go to the next level :smirk:.

If there are any issues encountered, please feel free to report an issue on my repository :slightly_smiling_face: 